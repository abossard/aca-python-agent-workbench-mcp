name: UI Screenshot

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

# Prevent duplicate runs - cancel in-progress runs when new commits are pushed
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  screenshot:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET 10
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Setup Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install Aspire CLI
        run: |
          dotnet tool install -g Aspire.Cli
          echo "$HOME/.dotnet/tools" >> $GITHUB_PATH

      - name: Verify Aspire CLI installation
        run: |
          aspire --version
          dotnet --version

      - name: Install Playwright
        run: |
          npm install -g playwright
          playwright install chromium
          playwright install-deps chromium

      - name: Start Aspire in background
        working-directory: ./PythonAspireSample
        run: |
          # Start Aspire in background with non-interactive mode
          # Aspire CLI will automatically:
          # - Install Python dependencies via uv (configured with .WithUv())
          # - Install frontend dependencies via npm
          # - Build the frontend
          # - Start all services (Python API, React frontend, Storage emulator)
          
          echo "Starting Aspire..."
          nohup aspire run --non-interactive > aspire.log 2>&1 &
          ASPIRE_PID=$!
          echo $ASPIRE_PID > aspire.pid
          echo "Started Aspire with PID $ASPIRE_PID"
          
          # Give it a moment to start
          sleep 5
          
          # Check if process is still running
          if kill -0 $ASPIRE_PID 2>/dev/null; then
            echo "Aspire process is running"
          else
            echo "Aspire process failed to start!"
            cat aspire.log
            exit 1
          fi
        env:
          ASPIRE_ALLOW_UNSECURED_TRANSPORT: 'true'
          DOTNET_ENVIRONMENT: 'Development'

      - name: Wait for services to be ready
        run: |
          echo "Waiting for services to start..."
          max_attempts=60
          attempt=0
          
          # Wait for Aspire dashboard
          while [ $attempt -lt $max_attempts ]; do
            if curl -sf http://localhost:18888 > /dev/null 2>&1; then
              echo "✓ Aspire dashboard is ready at http://localhost:18888"
              break
            fi
            
            attempt=$((attempt + 1))
            echo "Attempt $attempt/$max_attempts - waiting for Aspire dashboard..."
            sleep 5
          done
          
          if [ $attempt -eq $max_attempts ]; then
            echo "✗ Aspire dashboard failed to start after $(($max_attempts * 5)) seconds"
            echo "=== Aspire Logs ==="
            cat PythonAspireSample/aspire.log || echo "No log file found"
            exit 1
          fi
          
          # Wait additional time for app and frontend to be fully ready
          echo "Waiting for application services to initialize..."
          sleep 20
          
          echo "=== Service Status ==="
          echo "Checking running processes..."
          ps aux | grep -E "(aspire|python|node|uvicorn)" | grep -v grep || echo "No matching processes found"
          
          echo "=== Recent Aspire Logs ==="
          tail -50 PythonAspireSample/aspire.log || echo "No log file found"

      - name: Take screenshot
        run: |
          # Create a Playwright script to take a screenshot
          cat > screenshot.js << 'EOF'
          const { chromium } = require('playwright');
          
          (async () => {
            const browser = await chromium.launch({ 
              headless: true,
              args: ['--no-sandbox', '--disable-setuid-sandbox']
            });
            
            const context = await browser.newContext({
              viewport: { width: 1920, height: 1080 }
            });
            const page = await context.newPage();
            
            // Try common ports where frontend might be running
            const ports = [5173, 5174, 5000, 3000, 8080, 8000];
            let found = false;
            let successUrl = '';
            
            for (const port of ports) {
              try {
                const url = `http://localhost:${port}`;
                console.log(`Trying ${url}...`);
                await page.goto(url, { 
                  waitUntil: 'networkidle',
                  timeout: 10000 
                });
                console.log(`✓ Successfully connected to ${url}`);
                successUrl = url;
                found = true;
                break;
              } catch (e) {
                console.log(`✗ Port ${port} not accessible: ${e.message}`);
              }
            }
            
            if (!found) {
              console.error('Failed to connect to any service port');
              await browser.close();
              process.exit(1);
            }
            
            // Wait for any dynamic content to load
            console.log('Waiting for content to render...');
            await page.waitForTimeout(3000);
            
            // Take screenshot
            await page.screenshot({ 
              path: 'ui-screenshot.png',
              fullPage: true 
            });
            
            console.log(`✓ Screenshot saved to ui-screenshot.png from ${successUrl}`);
            
            await browser.close();
          })();
          EOF
          
          node screenshot.js || {
            echo "Screenshot capture failed!"
            exit 1
          }

      - name: Stop Aspire
        if: always()
        working-directory: ./PythonAspireSample
        run: |
          if [ -f aspire.pid ]; then
            PID=$(cat aspire.pid)
            echo "Stopping Aspire (PID: $PID)"
            kill $PID 2>/dev/null || true
            sleep 2
            kill -9 $PID 2>/dev/null || true
          fi
          
          # Clean up any remaining processes
          pkill -f "aspire run" || true
          pkill -f "dotnet.*apphost" || true
          
          echo "Cleanup complete"

      - name: Show logs on failure
        if: failure()
        run: |
          echo "=== Full Aspire Logs ==="
          cat PythonAspireSample/aspire.log || echo "No aspire.log found"
          echo ""
          echo "=== Running Processes ==="
          ps aux | grep -E "(aspire|dotnet|python|node)" | grep -v grep || echo "No processes found"
          echo ""
          echo "=== Network Ports ==="
          netstat -tuln | grep LISTEN || echo "No listening ports found"

      - name: Upload screenshot artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ui-screenshot
          path: ui-screenshot.png
          retention-days: 30

      - name: Upload logs artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: aspire-logs
          path: PythonAspireSample/aspire.log
          retention-days: 7
